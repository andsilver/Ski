<script>
  var map;
  var marker;

  function showMap() {
    <% unless @accommodation.geodata_lat.empty? %>
    var latlng = new google.maps.LatLng(<%= @accommodation.geodata_lat %>, <%= @accommodation.geodata_lng %>);
    var myOptions = {
      zoom: 16,
      center: latlng,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    map = new google.maps.Map(document.getElementById("map_canvas"),
      myOptions);
    marker = new google.maps.Marker({
      position: latlng,
      map: map,
      title:"<%= @property.name %>"
    });
    <% end %>
  }

	$(function() {
		$('#property_thumbnails a').fancyZoom({scaleImg: true, closeOnClick: true});

    var $dialog = $('<div id="map_canvas"></div>')
      .html('')
      .dialog({
        autoOpen: false,
        title: 'Location',
        width: 450,
        height: 350
      });

    $('#location').click(function() {
      $dialog.dialog('open');
      // prevent the default action, e.g., following a link
      google.maps.event.trigger(map, 'resize');
      map.setCenter(marker.getPosition());
      return false;
    });

    showMap();
	});

  function submit(extraValues) {
    var valuesToSubmit = $('#booking_form form').serialize() + extraValues;
    $('#booking_results').replaceWith('<div id="booking_results"><img src="/images/ajax-loader.gif" alt="Loading..."></div>');
    $.ajax({
      url: '/properties/check_interhome_booking',
      type: 'POST',
      data: valuesToSubmit
    }).success(function(data) {
      $('#booking_results').replaceWith(data);
    }).error(function(data) {
      $('#booking_results').replaceWith('<div id="booking_results"><h2>An error occurred. Please <a id="retry">try again</a>.</h2></div>');
      $('#retry').click(submitCheck);
    });
    return false;
  }

  function submitCheck() {
    submit('');
  }

  function isValidEmailAddress(emailAddress) {
    var pattern = new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);
    return pattern.test(emailAddress);
  }

  function submitBooking() {
    if($('#customer_salutation_type').val() == '') {
      alert('Please choose your title from the list.');
      $('#customer_salutation_type').focus();
      return;
    }
    if($('#customer_first_name').val() == '') {
      alert('Please enter your first name.');
      $('#customer_first_name').focus();
      return;
    }
    if($('#customer_name').val() == '') {
      alert('Please enter your surname.');
      $('#customer_name').focus();
      return;
    }
    email = $('#customer_email').val();
    if(email == '') {
      alert('Please enter your email address.');
      $('#customer_email').focus();
      return;
    }
    if(!isValidEmailAddress(email)) {
      alert('Please enter a valid email address.');
      $('#customer_email').focus();
      return;      
    }
    if(email.length > 69) {
      alert('Please enter an email address under 70 characters long.');
      $('#customer_email').focus();
      return;      
    }
    if($('#customer_address_street').val() == '') {
      alert('Please enter the first line of your address.');
      $('#customer_address_street').focus();
      return;
    }
    if($('#customer_address_place').val() == '') {
      alert('Please enter the town/city of your address.');
      $('#customer_address_place').focus();
      return;
    }
    if($('#customer_address_zip').val() == '') {
      alert('Please enter your postcode/ZIP.');
      $('#customer_address_zip').focus();
      return;
    }
    if($('#customer_address_country_code').val() == '') {
      alert('Please choose your country from the list.');
      $('#customer_address_country_code').focus();
      return;
    }
    if(!$('#terms_accepted').is(':checked')) {
      alert('You must accept Interhome\'s terms and conditions before you can make a booking.');
      $('#terms_accepted').focus();
      return;
    }
    submit('&submit=Book');
  }

  function updateDayOfMonthSelect() {
    var valuesToSubmit = 'year_month=' + $('#interhome_booking_arrival_month').val();
    $.ajax({
      url: '/properties/update_day_of_month_select',
      type: 'GET',
      data: valuesToSubmit
    }).success(function(data) {
      $('#day-of-month').replaceWith(data);
      if(window.selectDay) {
        $('#interhome_booking_arrival_day').val(selectDay);
        window.selectDay = 0;
      }
      submitCheck();
    }).error(function(data) {
      $('#day-of-month').replaceWith('<span id="day-of-month"><h2>An error occurred. Please <a id="retry-day-of-month">try again</a>.</h2></div>');
      $('#retry-day-of-month').click(updateDayOfMonthSelect);
    });
    return false;
  }

  $(function() {
    $('td[rel=popover]').popover();

    $('#booking_form').on('change', '.trigger-update input', submitCheck);
    $('#booking_form').on('change', '.trigger-update select', submitCheck);
    $('#booking_form').on('change', '#interhome_booking_arrival_month', updateDayOfMonthSelect);
    $('#booking_form').submit(function() { submitBooking(); return false; });
    $('.month .availability-Y').click(function() {
      window.selectDay = $(this).data('day');
      $('#interhome_booking_arrival_month').val($(this).data('month'));
      var new_position = $('#booking_results').offset();
      window.scrollTo(new_position.left, new_position.top);
      $('#interhome_booking_arrival_month').change();
    });

    $(function() {
      $('#later').click(function() {
        if($('.month:visible').last().next('.month').length) {
          a = $('.month:visible').last().next('.month');
          b = a.next();
          c = b.next();
          $('.month:visible').hide();
          a.show();
          b.show();
          c.show();
        }
      });

      $('#earlier').click(function() {
        if($('.month:visible').first().prev('.month').length) {
          a = $('.month:visible').first().prev('.month');
          b = a.prev();
          c = b.prev();
          $('.month:visible').hide();
          a.show();
          b.show();
          c.show();
        }
      });
    });
  });
</script>
<div id="content-with-side-banners">
<div id="property">
<%= render partial: 'user_logo', locals: { property: @property } %>
<div class="thumbnail abta">
  <img src="/images/abta.png" alt="ABTA Member">
  The tour operator<br>
  (Interhome) is an<br>
  ABTA Member<br>
  ABTA No. L7890
</div>
<h1 class="property_name"><span><%= t('property_name') %>:</span> <%= @property.name %>
<% unless @property.interhome_accommodation.interhome_place.nil? -%>
  (<%= @property.interhome_accommodation.interhome_place.name %>)
<% end -%>
</h1>
<p class="property_id"><%= I18n.t('property_id') %>: <span><%= @property.id %></span></p>

<% if fav = favourite_for_property(@property) %>
<%= form_for(fav, method: :delete) do |f| %>
<p>
  <%= f.submit t('favourites.remove'), class: 'btn btn-large' %>
  <%= render 'location_button' %>
</p>
<% end %>
<% else %>
<% @favourite = Favourite.new(property_id: @property.id) %>
<%= form_for @favourite do |f| %>
<%= f.hidden_field :property_id %>
<p>
  <button type="submit" class="btn btn-primary btn-large"><i class='icon-heart icon-white'></i>
  <%= t('favourites.add') %></button>
  <%= render 'location_button' %>
</p>
<% end %>
<% end %>

<% unless @property.image.nil? %>
<p class="thumbnails" id="property_thumbnails">
<% @property.images.each do |i| %>
<a href="#pic_<%= i.id %>"><%= image_tag(i.sized_url(135, :height), alt: "Photo of #{@property.name}") %></a>
<% end %>
</p>
<% @property.images.each do |i| %>
<div id="pic_<%= i.id %>"><img src="<%= i.url %>" alt="Larger photo of <%= @property.name %>"></div>
<% end %>
<%= clear %>
<% end %>

<h2><%= I18n.t('features') %></h2>
<div id="features">
  <div class="column">
    <%= I18n.t('bedrooms') %>: <%= @accommodation.bedrooms %>
  </div>
  <div class="column">
    <%= I18n.t('bathrooms') %>: <%= @accommodation.bathrooms %>
  </div>
  <div class="column">
    <%= I18n.t('sleeping_capacity') %>: <%= @accommodation.pax %>
  </div>
  <p class="divider">&nbsp;</p>
<%
features = @accommodation.features.split(',')
%>
<% features.each do |feature| %>
  <div class="column">
    <%= feature_tick(true, t("interhome.features.#{feature}")) %><br>
  </div>
<% end %>
  <%= clear %>
</div>

<h2><%= I18n.t('description') %></h2>
<h3>Inside</h3>
<p>
  <%= @accommodation.inside_description %>
</p>
<h3>Outside</h3>
<p>
  <%= @accommodation.outside_description %>
</p>

<% if @accommodation.interhome_vacancy %>
<% cal = InterhomeCalendar.new(@accommodation.interhome_vacancy) %>
<h2>Check availability</h2>
<div class="well">
<div class="btn-group">
  <button class="btn" id="earlier"><i class="icon-backward"></i> Earlier</button>
  <button class="btn" id="later">Later <i class="icon-forward"></i></button>
</div><!--.btn-group-->
<%
today = Date.today
month = today.month
year = today.year
hide = false
15.times do |i|
%>
  <div class="month" id="month<%= month %><%= year %>"
    data-month="<%= month %>" data-year="<%= year %>"
    <%= ' style="display: none;"'.html_safe if hide %>>
    <%= raw cal.show_month(month, year) %>
  </div><!--.month-->
  <% hide = true if (i + 1) % 3 == 0 %>
<%
  month += 1
  if month == 13
    month = 1
    year += 1
  end
end
%>
<% end %>
<%= clear %>
<section class="calendar-key">
  <h4>Key</h4>
  <table class="interhome-calendar">
    <tr>
      <td class="availability-Y">Available</td>
      <td class="availability-Y-no-check-in" rel="popover" data-original-title="No check-in" data-content="Some of our holiday rentals only accept arrivals on certain dates even though the property may be free on other days. Arrival dates are shown on the calendar as the dark green squares."><i class="icon-info-sign icon-white"></i> No check-in</td>
      <td class="availability-N">Unavailable</td>
      <td class="availability-Q">Booking possible only on request</td>
    </tr>
  </table>
</section>
</div><!--.well-->

<h2>Book your holiday</h2>
<p>
  Booking your summer or skiing holiday with MyChaletFinder is safe, simple and fast.
</p>
<div class="well">
<div id="booking_form">
<%= form_tag action: 'check_interhome_booking', id: @property.id do |form| %>
<input type="hidden" name="permalink" value="<%= params[:permalink] %>">
<h3>Travel dates</h3>
<span class="trigger-update">
<label>Date of arrival</label>
<span id="day-of-month">
<%= select('interhome_booking', 'arrival_day', booking_days(@interhome_booking.arrival_date.month, @interhome_booking.arrival_date.year)) %>
</span>
</span>
<%= select('interhome_booking', 'arrival_month', booking_months) %>
<div class="trigger-update">
<label>Duration of stay</label>
<%= select('interhome_booking', 'duration', booking_durations) %>
<h3>Travellers</h3>
<div class="row">
  <div class="span2">
    <label>
      Adults
      <input type="text" id="interhome_booking_adults" name="interhome_booking[adults]" value="<%= @interhome_booking.adults %>" class="span1">
    </label>
  </div>
  <div class="span2">
    <label>
      Children (3-12 years)
      <input type="text" id="interhome_booking_children" name="interhome_booking[children]" value="<%= @interhome_booking.children %>" class="span1">
    </label>
  </div>
  <div class="span2">
    <label>
      Babies (0-2 years)
      <input type="text" id="interhome_booking_babies" name="interhome_booking[babies]" value="<%= @interhome_booking.babies %>" class="span1">
    </label>
  </div>
</div>
</div><!--.trigger-update-->
<div id="booking_results">
  <p>
    Please select your dates of travel.
  </p>
</div>
<% end %>
</div><!--#booking_form-->
</div><!--.well-->

<%= clear %>

</div><!--#property-->
</div>
<div id="side-banners">
  <%= render partial: 'directory_adverts/banners', object: DirectoryAdvert.small_banners_for(@property.resort) %>
</div>
